{% extends "base.html" %}

{% block content %}
<div id="quiz-container">
  <!-- Use the secure image_url -->
  <input type="hidden" id="display-time" value="{{ image['display_time'] }}" />
  <input type="hidden" id="image-url" value="{{ image_url }}" />
  <input type="hidden" id="quiz-id" value="{{ quiz['id'] }}" />
  <input type="hidden" id="image-index" value="{{ image_index }}" />
  <input type="hidden" id="question-text" value="{{ image['question'] }}" />
  <input type="hidden" id="options" value='{{ image["options"]|tojson|safe }}' />
  
  <div id="quiz-root"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const QuizDisplay = () => {
  const [showImage, setShowImage] = React.useState(true);
  const [timer, setTimer] = React.useState(null);
  const [isAnswered, setIsAnswered] = React.useState(false);
  const [selectedAnswer, setSelectedAnswer] = React.useState('');
  const startTime = React.useRef(Date.now());

  const getInputValue = (id) => {
    const element = document.getElementById(id);
    return element ? element.value : null;
  };

  const displayTime = parseFloat(getInputValue('display-time')) || 5;
  const imageUrl = getInputValue('image-url');
  const quizId = getInputValue('quiz-id');
  const imageIndex = getInputValue('image-index');
  const questionText = getInputValue('question-text');
  let options = [];
  try {
    const optionsJson = getInputValue('options');
    options = optionsJson ? JSON.parse(optionsJson) : [];
  } catch (e) {
    console.error('Error parsing options:', e);
    options = [];
  }

  React.useEffect(() => {
    console.log('Image URL:', imageUrl); // Debug logging
    const newTimer = setTimeout(() => {
      setShowImage(false);
    }, displayTime * 1000);
    setTimer(newTimer);

    return () => {
      if (timer) clearTimeout(timer);
    };
  }, [displayTime]);

  const handleAnswer = (event) => {
    event.preventDefault();
    if (isAnswered) return;
    
    const formData = new FormData();
    formData.append('quiz_id', quizId);
    formData.append('image_index', imageIndex);
    formData.append('answer', selectedAnswer);
    formData.append('response_time', (Date.now() - startTime.current) / 1000);
    
    // Use absolute HTTPS URL
    fetch(window.location.protocol + '//' + window.location.host + '/submit_answer', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    }).then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response;
    }).then(() => {
      setIsAnswered(true);
      window.location.reload();
    }).catch(error => {
      console.error('Error:', error);
      alert('There was an error submitting your answer. Please try again.');
    });
  };

  const handleOptionChange = (option) => {
    setSelectedAnswer(option);
  };

  return React.createElement('div', { className: 'container mx-auto px-4 py-8 max-w-4xl' },
    React.createElement('div', { className: 'bg-white rounded-lg shadow-lg overflow-hidden' },
      React.createElement('div', { className: 'p-6' },
        // Fixed height container for image
        React.createElement('div', {
          className: 'relative w-full h-96 mb-8 bg-gray-50'
        },
          // Image with opacity transition
          React.createElement('img', {
            src: imageUrl,
            alt: 'Quiz',
            className: 'absolute inset-0 w-full h-full object-contain transition-opacity duration-300',
            style: {
              opacity: showImage ? 1 : 0
            }
          })
        ),

        // Question Section
        React.createElement('form', {
          onSubmit: handleAnswer,
          className: 'space-y-6'
        },
          React.createElement('div', { className: 'space-y-4' },
            React.createElement('h2', { className: 'text-xl font-semibold' },
              questionText
            ),
            React.createElement('div', { className: 'flex flex-col space-y-2' },
              options.map((option) =>
                React.createElement('label', {
                  key: option,
                  className: `flex items-center p-4 border rounded cursor-pointer ${
                    selectedAnswer === option ? 'border-blue-500 bg-blue-50' : 'border-gray-200'
                  }`
                },
                  React.createElement('input', {
                    type: 'radio',
                    name: 'answer',
                    value: option,
                    checked: selectedAnswer === option,
                    onChange: () => handleOptionChange(option),
                    className: 'mr-3'
                  }),
                  option
                )
              )
            )
          ),
          React.createElement('button', {
            type: 'submit',
            disabled: !selectedAnswer || isAnswered,
            className: 'w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed'
          }, 'Submit Answer')
        )
      )
    )
  );
};

// Initialize the React component
const root = ReactDOM.createRoot(document.getElementById('quiz-root'));
root.render(React.createElement(QuizDisplay));
</script>
{% endblock %}